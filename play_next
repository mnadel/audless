#!/bin/bash

dir=$(cd "$(dirname "${BASH_SOURCE[0]}")" &> /dev/null && pwd)
pidfile=${HOME}/play_next.pid

if [ -f ${pidfile} ]; then
    echo already playing
    exit 1
fi

activation=$(sqlite3 ${dir}/audless.db "SELECT value FROM config WHERE key='activation_bytes'")
next_up=$(sqlite3 ${dir}/audless.db "SELECT file,pos FROM queue WHERE pos <= end ORDER BY rank DESC LIMIT 1")

if [ "${next_up}" = "" ]; then
    echo queue is empty
    exit 0
fi

file=$(echo $next_up | awk -F'|' '{print $1}')
seek=$(echo $next_up | awk -F'|' '{print $2}')

echo starting ${file} at ${seek}

SDL_AUDIODRIVER=alsa AUDIODEV=hw ffplay -activation_bytes ${activation} \
    -hide_banner \
    -stats \
    -nodisp \
    -autoexit \
    -ss ${seek} \
    "${file}" >/dev/null 2>&1 &

pid=$!
disown ${pid}

echo ${pid} > ${pidfile}

nohup ${dir}/track "${file}" >/dev/null 2>&1 &
disown $!
